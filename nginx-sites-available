

## Copy the contents of this file into: /etc/nginx/sites-available/default

##
# sudo /etc/init.d/nginx start
# sudo /etc/init.d/nginx restart
# sudo nginx -t
##

## 
# Get certificate:
# sudo apt-get install certbot python-certbot-nginx
# sudo certbot --nginx
##

##
# Remember if configuring SSL for https: port-forward ports 80 & 443
##

##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

server {

	# SSL configuration:
	#
	listen 443 ssl http2 default_server;
	listen [::]:443 ssl http2 default_server;
	ssl on;

	server_name esantini.com www.esantini.com;

	root /home/pi/repos/eSantini/build;

	location / {
		try_files $uri /index.html;
	}

    # URI routing
    location /api/weather {
        limit_except GET {
            deny all; 
        }
        error_page 403 = @405; # Convert deny response from 403 (Forbidden) to 405 (Method Not Allowed)
        proxy_pass http://localhost:3001/api/weather;
    }
    location /api/message {
        limit_except GET POST {
            deny all; 
        }
        error_page 403 = @405; # Convert deny response from 403 (Forbidden) to 405 (Method Not Allowed)
        proxy_pass http://localhost:3001/api/message;
    }
    location /api/self-update {
        limit_except POST {
            deny all; 
        }
        error_page 403 = @405; # Convert deny response from 403 (Forbidden) to 405 (Method Not Allowed)
        proxy_pass http://localhost:3001/api/self-update;
    }

    ssl_certificate /etc/letsencrypt/live/esantini.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/esantini.com/privkey.pem; # managed by Certbot

}

server {
    if ($host = www.esantini.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = esantini.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


	listen 80 default_server;
	listen [::]:80 default_server;

	server_name esantini.com www.esantini.com;
    return 404; # managed by Certbot

}
